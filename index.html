<!DOCTYPE html>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<link href="stylesheets/style.css" rel="stylesheet" type="text/css">
</head>
<body>
  <div class="container">
    <canvas id="game" style="border: 1px solid #000;" height="500" width="500">Your browser doesn't support canvas</canvas>
    <ul id="chatlist">
      <li>You have joined chat.</li>
    <ul>
  </div>
  <form id="chat">
    <input id="chattext" type="text" maxlength="75">
    <input id="send" type="submit" value="send">
  </form>

<script src="/socket.io/socket.io.js"></script>
<script>
var socket = io.connect('http://localhost');
</script>
<script src="drawships.js"></script>
<script src="Stats.js"></script>
<script>
var x = 70;
var y = 70;
var myid = 0;
var ship;
var players = new Array();
var upp = false, downp = false, leftp = false, rightp = false, xstop = false;
var starlist;


socket.on('newstart', function (data) {
  x = data.x;
  y = data.y;
  starlist = data.slist;
  myid = data.id;
  ship = data.ship;
  players = data.currentplayers;
  players[myid] = { id: myid, ship: ship, x: x, y: y };
});
socket.on('newguy', function (data) {
  players[data.id] = ({id: data.id, ship: data.ship, x: data.x, y: data.y });
  });
socket.on('update', function (data) {
   x = data.x;
   y = data.y;
  players[data.id] = { id: data.id, ship: data.ship, x: data.x, y: data.y };
  });
socket.on('removeplayer', function (data) {
  players.splice(data.id, 1, []);
});
socket.on('chatmessageresponse', function (data) {
  $("#chatlist").append('<li>User ' + data.id + ' said: ' + data.msg + '</li>');
  $("#chatlist").scrollTop($("#chatlist")[0].scrollHeight);
});

function game() {
  //fps counter next 2 lines
  var stats = new Stats();
  stats.setMode(0);
  stats.domElement.style.position = 'absolute';
  stats.domElement.style.left = '0px';
  stats.domElement.style.top = '0px';
	document.body.appendChild( stats.domElement );
  // Get the canvas element and its drawing context
  var canvas = document.getElementById('game');
  var context = canvas.getContext('2d');
  var context_width = canvas.width;
  var context_height = canvas.height;
  var gameloop = setInterval(function() {
  //fps counter
  stats.begin();

  updateAll();
  //reset canvas in between each frame, paint it black for space
  context.fillStyle = 'black';
  context.fillRect(0, 0, context_width, context_height);
  drawAll(context, starlist, context_width, context_height);
  
  //fps counter
  stats.end();
  }, 33);
}

function updateAll() {
  // send a single update packet with everything that's happened
  //here 'p' stands for pressed
  //if (upp || downp || leftp || rightp) {
    socket.emit('dataupdate', { id: myid, up: upp, down: downp, left: leftp, right: rightp, xpressed: xstop });
  //}
}
  
function drawAll(context, starlist, cw, ch) {
  //these are needed because the 0,0 of the ship sprite is the upper left corner, not the center
  var xadjust = cw/2 - 24;
  var yadjust = ch/2 - 22;
  stars(context, starlist, players[myid].x, players[myid].y, cw, ch);

  //draw other players-- this has to be changed so they are drawn in relation to the player's current position
  for (var playerid in players) {
    if (players[playerid].x != null && playerid != myid) {
      drawPlayer(context, players[playerid].ship, players[playerid].x + xadjust - players[myid].x, players[playerid].y + yadjust - players[myid].y);
    }
  }
  
  //draw the player in the middle of the screen
  drawPlayer(context, players[myid].ship, xadjust, yadjust);
}

function stars(ctx, starlist, px, py, cw, ch) {
        for (var i in starlist) {
          var x = starlist[i][0];
          var y = starlist[i][1];
          // Make the stars white
          ctx.fillStyle = "white";
        //check if star would be within view field
        if (Math.abs(px - x) < cw/2 + 5 && Math.abs(py - y) < ch/2 + 5){
          //transform coords from world coordinate system to pixel coordinate system
          x = x + (cw/2);
          y = y + (ch/2);
          ctx.beginPath();
          ctx.arc(x - px, y - py, 3, 0, Math.PI * 2, true);
          ctx.closePath();
          ctx.fill();
        }
        }
      }

function drawPlayer(ctx, ship, x, y) {
  var context = ctx; 
  if (ship == 1) {
    ship1draw(ctx,x,y);
  }
  else if (ship == 2) {
    ship2draw(ctx,x,y);
  }
}

window.addEventListener("load", game, true);
$(document.documentElement).keydown(function (event) {
  // handle cursor keys
  if (event.keyCode == 37) {
      leftp = true;
  } else if (event.keyCode == 39) {
      rightp = true;
  }
 if (event.keyCode == 38) {
      upp = true;
  } else if (event.keyCode == 40) {
      downp = true;
  }
  if (event.keyCode == 27) {
      xstop = true;
  }
});
//This handler detects when the keys are no longer being pressed
$(document.documentElement).keyup(function (event) {
  if (event.keyCode == 37) {
      leftp = false;
  } else if (event.keyCode == 39) {
      rightp = false;
  }
 if (event.keyCode == 38) {
      upp = false;
  } else if (event.keyCode == 40) {
      downp = false;
  }
  if (event.keyCode == 27) {
      xstop = false;
  }
});
//chat implementation
$("#chat").submit(function(event) {
  event.preventDefault();
  var value = $("#chattext").val();
  $("#chattext").val('');
  /*$("#chatlist").append('<li>User ' + myid + ' said: ' + value + '</li>');
  $("#chatlist").scrollTop($("#chatlist")[0].scrollHeight);*/
  socket.emit('chatmessagesend', { id: myid, message: value });
});
</script>
</body>
</html>
