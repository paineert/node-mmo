<!DOCTYPE html>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<link href="stylesheets/style.css" rel="stylesheet" type="text/css">
</head>
<body>
  <div class="container">
    <canvas id="game" style="border: 1px solid #000;" height="700" width="700">Your browser doesn't support canvas</canvas>
    <ul id="chatlist">
      <h2>Text Chat</h2>
      <li>You have joined chat.</li>
    <ul>
  </div>
  <form id="chat">
    <input id="chattext" type="text" maxlength="75">
    <input id="send" type="submit" value="send">
  </form>
<!--preload fonts-->
<div style="font-family: Gotham Medium;">.</div>
<div style="font-family: Gotham Bold;">.</div>

<script src="/socket.io/socket.io.js"></script>
<script>
var socket = io.connect('http://localhost');
</script>
<script src="shipsdraw.js"></script>
<script src="Stats.js"></script>
<script>
var myid = 0;
var ship;
var leveledUp = false;
var players = new Array();
var upp = false, downp = false, leftp = false, rightp = false, xstop = false;
var starlist;

socket.on('newstart', function (data) {
  starlist = data.slist;
  window.waypoint = data.wp;
  myid = data.id;
  ship = data.ship;
  players = data.currentplayers;
  players[myid] = { id: myid, ship: ship, x: 0, y: 0, a:0, level:0, xp:0, wp:waypoint};
});
socket.on('newguy', function (data) {
  players[data.id] = ({id: data.id, ship: data.ship, x: data.x, y: data.y });
});
socket.on('disconnect', function () {
  alert('you were disconnected.');
});
socket.on('update', function (data) {  
  players[data.id].ship = data.ship;
  players[data.id].x = data.x;
  players[data.id].y = data.y;
  players[data.id].a = data.a;
});
socket.on('removeplayer', function (data) {
  players.splice(data.id, 1, []);
});
socket.on('chatmessageresponse', function (data) {
  if (data.playermsg) {
  $("#chatlist").append('<li>Player ' + data.id + ' said: ' + data.msg + '</li>');
  }
  else {
  $("#chatlist").append('<li style="font-family:Gotham Bold;color:#00A2E8;">' + data.msg + '</li>');
  }
  $("#chatlist").scrollTop($("#chatlist")[0].scrollHeight);
});
socket.on('newwaypoint', function (data) {
    window.waypoint = data.wp;
    console.log('waypoint changed');
});
socket.on('leveledup', function (data) {
  console.log('fired!' + 'level is ' + data.level);
  players[myid].level = data.level;
  leveledUp = true;
  setTimeout( function() {leveledUp = false;}, 5000);
});
function game() {
  initialize_ships();
  //fps counter next 2 lines
  var stats = new Stats();
  stats.setMode(0);
  stats.domElement.style.position = 'absolute';
  stats.domElement.style.left = '0px';
  stats.domElement.style.top = '0px';
	document.body.appendChild( stats.domElement );
	
  // Get the canvas element and its drawing context
  var canvas = document.getElementById('game');
  var context = canvas.getContext('2d');
  var context_width = canvas.width;
  var context_height = canvas.height;
  
  //prerender complex stars
  var s_canvas = document.createElement('canvas');
  s_canvas.width = 39;
  s_canvas.height = 32;
  var s_context = s_canvas.getContext('2d');
  var img = new Image();
  img.onload = function(){
    s_context.drawImage(img,0,0);
  }
  img.src = 'images/star1.png';
  
  //prerender background image
  var b_canvas = document.createElement('canvas');
  b_canvas.width = 2163;
  b_canvas.height = 1756;
  var b_context = b_canvas.getContext('2d');
  var bimg = new Image();
  bimg.onload = function(){
    b_context.drawImage(bimg,0,0);
  }
  bimg.src = 'images/space.jpg';
  
  var backgroundstars = initiateStars(context_width, context_height);
  var gameloop = setInterval(function() {
  //fps counter
  stats.begin();
  updateAll();
  //reset canvas in between each frame, paint it black for space
  context.fillStyle = 'black';
  context.fillRect(0, 0, context_width, context_height);
  drawAll(context, s_canvas, context_width, context_height, backgroundstars, b_canvas);
  
  //fps counter
  stats.end();
  }, 33);
}

function updateAll() {
  // send a single update packet with everything that's happened
  //here 'p' stands for pressed
  //if (upp || downp || leftp || rightp) {
    socket.emit('dataupdate', { id: myid, up: upp, down: downp, left: leftp, right: rightp, xpressed: xstop });
  //}
}
  
function drawAll(context, s_canvas, cw, ch, bgstars, b_canvas) {
  //these are needed because the 0,0 of the ship sprite is the upper left corner, not the center
  var xadjust = cw/2;
  var yadjust = ch/2;
  bgimgdraw(context, players[myid].x, players[myid].y, b_canvas);
  bgstarsdraw(context, players[myid].x, players[myid].y, cw, ch, bgstars);
  stars(context, s_canvas, players[myid].x, players[myid].y, cw, ch);
  
  //draw other players
  for (var playerid in players) {
    if (players[playerid].x != null && playerid != myid) {
      drawPlayerName(context, players[playerid].x + xadjust - players[myid].x, players[playerid].y + yadjust - players[myid].y, playerid, players[playerid].ship);
      
      drawPlayer(context, players[playerid].ship, players[playerid].x + xadjust - players[myid].x, players[playerid].y + yadjust - players[myid].y, players[playerid].a, false);
    }
  }
  //draw the player in the middle of the screen
  drawPlayer(context, players[myid].ship, 0, 0, players[myid].a, true);
  drawWaypoint(context, players[myid].ship, players[myid].x, players[myid].y, cw, ch);
  drawLevelUp(context, cw, ch);
}

function stars(ctx, s_canvas, px, py, cw, ch) {
  for (var i in starlist) {
    var x = starlist[i][0];
    var y = starlist[i][1];
    //check if star would be within view field
    if (Math.abs(px - x) < cw/2 + 39 && Math.abs(py - y) < ch/2 + 39){
        //transform coords from world coordinate system to pixel coordinate system
        x = x + (cw/2);
        y = y + (ch/2);
        //old code makes a circle, new code draws pre-rendered image
        //ctx.arc(x - px, y - py, 6, 0, Math.PI * 2, true);
        ctx.drawImage(s_canvas,x - px, y - py);
    }
  }
}

function bgstarsdraw(ctx, px, py, cw, ch, starlist) {
  for (var i in starlist) {
    var x = starlist[i][0];
    var y = starlist[i][1];
    // Make the stars white
    ctx.fillStyle = "white";
    //check if star would be within view field
    if (Math.abs(px/1.5 - x) < cw/2 + 5 && Math.abs(py/1.5 - y) < ch/2 + 5){
      //transform coords from world coordinate system to pixel coordinate system
      x = x + (cw/2);
      y = y + (ch/2);
      ctx.beginPath();
      //draw circle
      ctx.arc(x - px/1.5, y - py/1.5, 2, 0, Math.PI * 2, true);
      ctx.closePath();
      ctx.fill();
    }
  }
}

function bgimgdraw(ctx, px, py, b_canvas) {
  //draw pre-rendered hubble image          
  ctx.drawImage(b_canvas,-400 - px/60,-400 - py/60);
}

function drawPlayer(ctx, ship, x, y, a, center) {
  if (ship == 1) {
    ship1draw(ctx,x,y,a,center);
  }
  else if (ship == 2) {
    ship2draw(ctx,x,y,a,center);
  }
}

function drawPlayerName(ctx, x, y, id, ship) {
    var string = "Player " + id;
    ctx.font = '10px Gotham Medium'
    if (ship == 1){
      ctx.fillText(string, x-20, y-38);
    }
    else if (ship == 2) {
      ctx.fillText(string, x-20, y-38);
    }
}
function drawWaypoint(ctx, ship, x, y, cw, ch) {
  //var waypoint = window.waypoint;
  var distance = Math.sqrt(Math.pow(x-waypoint.x, 2) + Math.pow(y-waypoint.y,2));
  var moddist = (200* Math.PI) / distance;
  if (y > waypoint.y && x > waypoint.x) {
    var fraction = (y-waypoint.y)/(x-waypoint.x);
    var pureangle = Math.atan(fraction) + Math.PI;
    var angle1 = pureangle - moddist;
    var angle2 = pureangle + moddist;
  }
  if (waypoint.y > y && waypoint.x > x) {
    var fraction = (waypoint.y - y)/(waypoint.x - x);
    var pureangle = Math.atan(fraction);
    var angle1 = pureangle - moddist;
    var angle2 = pureangle + moddist;
  }
  if (y > waypoint.y && waypoint.x > x) {
    var fraction = (y - waypoint.y)/(waypoint.x - x);
    var pureangle = Math.atan(fraction) * -1;
    var angle1 = pureangle - moddist;
    var angle2 = pureangle + moddist;
  }
  if (waypoint.y > y && x > waypoint.x) {
    var fraction = (waypoint.y - y)/(x - waypoint.x);
    var pureangle = (Math.atan(fraction) + Math.PI) * -1;
    var angle1 = pureangle - moddist;
    var angle2 = pureangle + moddist;
  }
  ctx.save();
  ctx.shadowOffsetX = 2;
  ctx.shadowOffsetY = 2;
  ctx.shadowBlur = 5;
  ctx.shadowColor = "rgba(0, 0, 0, 0.3)";
  // Increase line width
  ctx.lineWidth = 5;
  ctx.beginPath();
  ctx.strokeStyle = "rgba(255, 209, 117,.5)";//cool blue: 0,162,232, yellow: 255, 209, 117,.7
  var gradient = ctx.createRadialGradient(cw/2, ch/2+7, 30, cw/2, ch/2+7, 50);
  gradient.addColorStop(0, "rgba(241, 218, 54,.5)");
  gradient.addColorStop(1, "rgba(252, 227, 0,.5)");
  ctx.strokeStyle = gradient;
  ctx.arc(cw/2, ch/2, 45, angle1, angle2, false);
  ctx.stroke();
  ctx.restore();
}
function drawLevelUp(ctx, cw, ch) {
  if (leveledUp){
    ctx.save();
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;
    ctx.shadowBlur = 5;
    ctx.shadowColor = "rgba(0, 0, 0, 0.7)";
    var gradient = ctx.createLinearGradient(0, 210, 0, 350);
    gradient.addColorStop(0, "rgb(255, 255, 255)");
    gradient.addColorStop(1, "rgb(80, 80, 80)");
    ctx.fillStyle = gradient;
    ctx.font = '48px Gotham Bold';
    ctx.fillText("Congratulations!", cw/2 - 200, ch/2- 100);
    ctx.font = '16px Gotham Bold';
    ctx.fillText("You have reached level " + players[myid].level, cw/2 - 100, ch/2- 70);
    ctx.restore();
  }
}
window.addEventListener("load", game, true);
$(document.documentElement).keydown(function (event) {
  // handle cursor keys
  if (event.keyCode == 37) {
      leftp = true;
  } else if (event.keyCode == 39) {
      rightp = true;
  }
 if (event.keyCode == 38) {
      upp = true;
  } else if (event.keyCode == 40) {
      downp = true;
  }
  if (event.keyCode == 27) {
      xstop = true;
  }
});
//This handler detects when the keys are no longer being pressed
$(document.documentElement).keyup(function (event) {
  if (event.keyCode == 37) {
      leftp = false;
  } else if (event.keyCode == 39) {
      rightp = false;
  }
 if (event.keyCode == 38) {
      upp = false;
  } else if (event.keyCode == 40) {
      downp = false;
  }
  if (event.keyCode == 27) {
      xstop = false;
  }
});
//chat implementation
$("#chat").submit(function(event) {
  event.preventDefault();
  var value = $("#chattext").val();
  $("#chattext").val('');
  socket.emit('chatmessagesend', { id: myid, playermsg: true, msg: value });
});

function initiateStars(w,h) {
  var temparray = new Array();
  var numStars = 10000;
  // Generate numStars stars, with a quarter in each quadrant. (0,0 is the world centerpoint)
  for (i = 0; i <= numStars/4; i++) {
    // Get random positions for stars.
    var x = Math.floor(Math.random() * ((w * 10)-1));
    var y = Math.floor(Math.random() * ((h * 10)-1));
    temparray[i] = [x,y];
  }
  for (i = (numStars/4 + 1); i <= numStars/2; i++) {
    // Get random positions for stars.
    var x = Math.floor(Math.random() * ((w * -10)-1));
    var y = Math.floor(Math.random() * ((h * 10)-1));
    temparray[i] = [x,y];
  }
  for (i = (numStars/2 + 1); i <= 3*(numStars/4); i++) {
    // Get random positions for stars.
    var x = Math.floor(Math.random() * ((w * 10)-1));
    var y = Math.floor(Math.random() * ((h * -10)-1));
    temparray[i] = [x,y];
  }
  for (i = (3*(numStars/4) + 1); i <= numStars; i++) {
    // Get random positions for stars.
    var x = Math.floor(Math.random() * ((w * -10)-1));
    var y = Math.floor(Math.random() * ((h * -10)-1));
    temparray[i] = [x,y];
  }
  return temparray;
}
</script>
</body>
</html>
