<!DOCTYPE html>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<link href="stylesheets/style.css" rel="stylesheet" type="text/css">
</head>
<body>
  <div class="container">
    <canvas id="game" style="border: 1px solid #000;" height="700" width="700">Your browser doesn't support canvas</canvas>
    <ul id="chatlist">
      <h2>Text Chat</h2>
      <li>You have joined chat.</li>
    <ul>
  </div>
  <form id="chat">
    <input id="chattext" type="text" maxlength="75">
    <input id="send" type="submit" value="send">
  </form>
<!--preload fonts-->
<div style="font-family: Gotham Medium;">.</div>
<div style="font-family: Gotham Bold;">.</div>

<script src="/socket.io/socket.io.js"></script>
<script>
var socket = io.connect('http://localhost');
</script>
<script src="drawships.js"></script>
<script src="Stats.js"></script>
<script>
var x = 0;
var y = 0;
var myid = 0;
var ship;
var players = new Array();
var upp = false, downp = false, leftp = false, rightp = false, xstop = false;
var starlist;

socket.on('newstart', function (data) {
  x = data.x;
  y = data.y;
  starlist = data.slist;
  window.waypoint = data.wp;
  myid = data.id;
  ship = data.ship;
  players = data.currentplayers;
  players[myid] = { id: myid, ship: ship, x: x, y: y, level:0, xp:0, wp:waypoint};
});
socket.on('newguy', function (data) {
  players[data.id] = ({id: data.id, ship: data.ship, x: data.x, y: data.y });
});
socket.on('disconnect', function () {
  alert('you were disconnected.');
});
socket.on('update', function (data) {
  //x = data.x;
  //y = data.y;
  players[data.id] = { id: data.id, ship: data.ship, x: data.x, y: data.y };
});
socket.on('removeplayer', function (data) {
  players.splice(data.id, 1, []);
});
socket.on('chatmessageresponse', function (data) {
  $("#chatlist").append('<li>Player ' + data.id + ' said: ' + data.msg + '</li>');
  $("#chatlist").scrollTop($("#chatlist")[0].scrollHeight);
});
socket.on('newwaypoint', function (data) {
    window.waypoint = data.wp;
    console.log('waypoint changed');
});
function game() {
  //fps counter next 2 lines
  var stats = new Stats();
  stats.setMode(0);
  stats.domElement.style.position = 'absolute';
  stats.domElement.style.left = '0px';
  stats.domElement.style.top = '0px';
	document.body.appendChild( stats.domElement );
  // Get the canvas element and its drawing context
  var canvas = document.getElementById('game');
  var context = canvas.getContext('2d');
  var context_width = canvas.width;
  var context_height = canvas.height;
  
  //prerender complex stars
  var s_canvas = document.createElement('canvas');
  s_canvas.width = 39;
  s_canvas.height = 32;
  var s_context = s_canvas.getContext('2d');
  var img = new Image();
  img.onload = function(){
    s_context.drawImage(img,0,0);
  }
  img.src = 'images/star1.png';
  
  var backgroundstars = initiateStars(context_width, context_height);
  var gameloop = setInterval(function() {
  //fps counter
  stats.begin();

  updateAll();
  //reset canvas in between each frame, paint it black for space
  context.fillStyle = 'black';
  context.fillRect(0, 0, context_width, context_height);
  drawAll(context, s_canvas, context_width, context_height, backgroundstars);
  
  
  //should move this code to another place, also hook it up to fire only after level up
  if (leveledup){
    var gradient = context.createLinearGradient(0, 210, 0, 300);
    gradient.addColorStop(0, "rgb(255, 255, 255)");
    gradient.addColorStop(1, "rgb(80, 80, 80)");
    context.fillStyle = gradient;
    context.font = '48px Gotham Bold';
    context.fillText("Congratulations!", context_width/2 - 200, context_height/2- 100);
    context.font = '16px Gotham Bold';
    context.fillText("You have reached level 5", context_width/2 - 100, context_height/2- 70);
  }
  
  //fps counter
  stats.end();
  }, 33);
}

function updateAll() {
  // send a single update packet with everything that's happened
  //here 'p' stands for pressed
  //if (upp || downp || leftp || rightp) {
    socket.emit('dataupdate', { id: myid, up: upp, down: downp, left: leftp, right: rightp, xpressed: xstop });
  //}
}
  
function drawAll(context, s_canvas, cw, ch, bgstars) {
  //these are needed because the 0,0 of the ship sprite is the upper left corner, not the center
  var xadjust = cw/2 - 24;
  var yadjust = ch/2 - 22;
  bgstarsdraw(context, players[myid].x, players[myid].y, cw, ch, bgstars);
  stars(context, s_canvas, players[myid].x, players[myid].y, cw, ch);
  //draw other players-- this has to be changed so they are drawn in relation to the player's current position
  for (var playerid in players) {
    if (players[playerid].x != null && playerid != myid) {
      drawPlayerName(context, players[playerid].x + xadjust - players[myid].x, players[playerid].y + yadjust - players[myid].y, playerid, players[playerid].ship);
      
      drawPlayer(context, players[playerid].ship, players[playerid].x + xadjust - players[myid].x, players[playerid].y + yadjust - players[myid].y);
    }
  }
  //draw the player in the middle of the screen
  drawPlayer(context, players[myid].ship, xadjust, yadjust);
  drawWaypoint(context, players[myid].ship, players[myid].x, players[myid].y, cw, ch);
}

function stars(ctx, s_canvas, px, py, cw, ch) {
        for (var i in starlist) {
          var x = starlist[i][0];
          var y = starlist[i][1];
        //check if star would be within view field
        if (Math.abs(px - x) < cw/2 + 39 && Math.abs(py - y) < ch/2 + 39){
          //transform coords from world coordinate system to pixel coordinate system
          x = x + (cw/2);
          y = y + (ch/2);
          //old code makes a circle, new code draws pre-rendered image
          //ctx.arc(x - px, y - py, 6, 0, Math.PI * 2, true);
          ctx.drawImage(s_canvas,x - px, y - py);
        }
        }
}

function bgstarsdraw(ctx, px, py, cw, ch, starlist) {
        for (var i in starlist) {
          var x = starlist[i][0];
          var y = starlist[i][1];
          // Make the stars white
          ctx.fillStyle = "white";
        //check if star would be within view field
        if (Math.abs(px/1.5 - x) < cw/2 + 5 && Math.abs(py/1.5 - y) < ch/2 + 5){
          //transform coords from world coordinate system to pixel coordinate system
          x = x + (cw/2);
          y = y + (ch/2);
          ctx.beginPath();
          //old code makes a circle, new code draws pre-rendered image
          ctx.arc(x - px/1.5, y - py/1.5, 2, 0, Math.PI * 2, true);
          ctx.closePath();
          ctx.fill();
        }
        }
}

function drawPlayer(ctx, ship, x, y) {
  if (ship == 1) {
    ship1draw(ctx,x,y);
  }
  else if (ship == 2) {
    ship2draw(ctx,x,y);
  }
}

function drawPlayerName(ctx, x, y, id, ship) {
    var string = "Player " + id;
    ctx.font = '10px Gotham Medium'
    if (ship == 1){
      ctx.fillText(string, x+4, y-4);
    }
    else if (ship == 2) {
      ctx.fillText(string, x+2, y-3);
    }
}
function drawWaypoint(ctx, ship, x, y, cw, ch) {
  //var waypoint = window.waypoint;
  var distance = Math.sqrt(Math.pow(x-waypoint.x, 2) + Math.pow(y-waypoint.y,2));
  var moddist = (200* Math.PI) / distance;
  if (y > waypoint.y && x > waypoint.x) {
    var fraction = (y-waypoint.y)/(x-waypoint.x);
    var pureangle = Math.atan(fraction) + Math.PI;
    var angle1 = pureangle - moddist;
    var angle2 = pureangle + moddist;
  }
  if (waypoint.y > y && waypoint.x > x) {
    var fraction = (waypoint.y - y)/(waypoint.x - x);
    var pureangle = Math.atan(fraction);
    var angle1 = pureangle - moddist;
    var angle2 = pureangle + moddist;
  }
  if (y > waypoint.y && waypoint.x > x) {
    var fraction = (y - waypoint.y)/(waypoint.x - x);
    var pureangle = Math.atan(fraction) * -1;
    var angle1 = pureangle - moddist;
    var angle2 = pureangle + moddist;
  }
  if (waypoint.y > y && x > waypoint.x) {
    var fraction = (waypoint.y - y)/(x - waypoint.x);
    var pureangle = (Math.atan(fraction) + Math.PI) * -1;
    var angle1 = pureangle - moddist;
    var angle2 = pureangle + moddist;
  }
  // Increase line width
  ctx.lineWidth = 5;
  ctx.beginPath();
  //ctx.strokeStyle = "rgba(255, 209, 117,.7)";//cool color, should use later: 0,162,232
  var gradient = ctx.createRadialGradient(cw/2, ch/2+7, 30, cw/2, ch/2+7, 50);
  gradient.addColorStop(0, "rgb(241, 218, 54)");
  gradient.addColorStop(1, "rgb(252, 227, 0)");
  ctx.strokeStyle = gradient;
  ctx.arc(cw/2, ch/2 + 7, 40, angle1, angle2, false);
  ctx.stroke();
}
window.addEventListener("load", game, true);
$(document.documentElement).keydown(function (event) {
  // handle cursor keys
  if (event.keyCode == 37) {
      leftp = true;
  } else if (event.keyCode == 39) {
      rightp = true;
  }
 if (event.keyCode == 38) {
      upp = true;
  } else if (event.keyCode == 40) {
      downp = true;
  }
  if (event.keyCode == 27) {
      xstop = true;
  }
});
//This handler detects when the keys are no longer being pressed
$(document.documentElement).keyup(function (event) {
  if (event.keyCode == 37) {
      leftp = false;
  } else if (event.keyCode == 39) {
      rightp = false;
  }
 if (event.keyCode == 38) {
      upp = false;
  } else if (event.keyCode == 40) {
      downp = false;
  }
  if (event.keyCode == 27) {
      xstop = false;
  }
});
//chat implementation
$("#chat").submit(function(event) {
  event.preventDefault();
  var value = $("#chattext").val();
  $("#chattext").val('');
  /*$("#chatlist").append('<li>User ' + myid + ' said: ' + value + '</li>');
  $("#chatlist").scrollTop($("#chatlist")[0].scrollHeight);*/
  socket.emit('chatmessagesend', { id: myid, message: value });
});

function initiateStars(w,h) {
  var temparray = new Array();
  var numStars = 10000;
  // Generate numStars stars, with a quarter in each quadrant. (0,0 is the world centerpoint)
  for (i = 0; i <= numStars/4; i++) {
    // Get random positions for stars.
    var x = Math.floor(Math.random() * ((w * 10)-1));
    var y = Math.floor(Math.random() * ((h * 10)-1));
    temparray[i] = [x,y];
  }
  for (i = (numStars/4 + 1); i <= numStars/2; i++) {
    // Get random positions for stars.
    var x = Math.floor(Math.random() * ((w * -10)-1));
    var y = Math.floor(Math.random() * ((h * 10)-1));
    temparray[i] = [x,y];
  }
  for (i = (numStars/2 + 1); i <= 3*(numStars/4); i++) {
    // Get random positions for stars.
    var x = Math.floor(Math.random() * ((w * 10)-1));
    var y = Math.floor(Math.random() * ((h * -10)-1));
    temparray[i] = [x,y];
  }
  for (i = (3*(numStars/4) + 1); i <= numStars; i++) {
    // Get random positions for stars.
    var x = Math.floor(Math.random() * ((w * -10)-1));
    var y = Math.floor(Math.random() * ((h * -10)-1));
    temparray[i] = [x,y];
  }
  return temparray;
}
</script>
</body>
</html>
