<!DOCTYPE html>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
</head>
<body>
<canvas id="game" style="border: 1px solid #000;" height="800" width="800">Your browser doesn't support canvas</canvas>
<script src="/socket.io/socket.io.js"></script>
<script>
  var socket = io.connect('http://localhost');
</script>
<script src="drawships.js"></script>
<script>
var x = 70;
var y = 70;
var myid = 0;
var ship;
var players = new Array();
var upp = false, downp = false, leftp = false, rightp = false, xstop = false;

//Debug stuff:
var drawInterval = 33;
var frameCount = 0;
var fps = 0;
var maxfps = 1 / (drawInterval / 1000);
var lastTime = new Date();


socket.on('newstart', function (data) {
  x = data.x;
  y = data.y;
  myid = data.id;
  ship = data.ship;
  players = data.currentplayers;
  players[myid] = { id: myid, ship: ship, x: x, y: y };
});
socket.on('newguy', function (data) {
  players[data.id] = ({id: data.id, ship: data.ship, x: data.x, y: data.y });
  });
socket.on('update', function (data) {
   x = data.x;
   y = data.y;
  players[data.id] = { id: data.id, ship: data.ship, x: data.x, y: data.y };
  });
socket.on('removeplayer', function (data) {
  players.splice(data.id, 1, []);
});

function game() {
  // Get the canvas element and its drawing context
  var canvas = document.getElementById('game');
  var context = canvas.getContext('2d');
  var context_width = canvas.width;
  var context_height = canvas.height;
  var starlist = initiateStars(context_width, context_height);
  var gameloop = setInterval(function() {
    //these lines are for framerate stuff
    var nowTime = new Date();
    var diffTime = Math.ceil((nowTime.getTime() - lastTime.getTime()));
    if (diffTime >= 1000) {
    fps = frameCount;
    frameCount = 0.0;
    lastTime = nowTime;
    }

  updateAll();
  //reset canvas in between each frame, paint it black for space
  context.fillStyle = 'black';
  context.fillRect(0, 0, context_width, context_height);
  drawAll(context, starlist, context_width, context_height);
    //framerate stuff
    frameCount++;
    
  }, drawInterval);
}

function updateAll() {
  // send a single update packet with everything that's happened
  //here 'p' stands for pressed
  //if (upp || downp || leftp || rightp) {
    socket.emit('dataupdate', { id: myid, up: upp, down: downp, left: leftp, right: rightp, xpressed: xstop });
  //}
}
  
function drawAll(context, starlist, cw, ch) {
  //these are needed because the 0,0 of the ship sprite is the upper left corner, not the center
  var xadjust = cw/2 - 24;
  var yadjust = ch/2 - 22;
  stars(context, starlist, players[myid].x, players[myid].y, cw, ch);
  //draw the player in the middle of the screen
  drawPlayer(context, players[myid].ship, xadjust, yadjust);

  //draw other players-- this has to be changed so they are drawn in relation to the player's current position
  for (var playerid in players) {
    if (players[playerid].x != null && playerid != myid) {
      drawPlayer(context, players[playerid].ship, players[playerid].x + xadjust - players[myid].x, players[playerid].y + yadjust - players[myid].y);
    }
  }
  framerateDraw(context);
}

//TODO: generate some negative coordinate stars as well
//TODO: move star generation logic to the server, have it pass the array to the client upon connection
function initiateStars(w,h) {
  var temparray = new Array();
  var numStars = 100000;
  // Generate numStars stars, with a quarter in each quadrant. (0,0 is the world centerpoint)
  for (i = 0; i <= numStars/4; i++) {
    // Get random positions for stars.
    var x = Math.floor(Math.random() * ((w * 10)-1));
    var y = Math.floor(Math.random() * ((h * 10)-1));
    temparray[i] = [x,y];
  }
  for (i = (numStars/4 + 1); i <= numStars/2; i++) {
    // Get random positions for stars.
    var x = Math.floor(Math.random() * ((w * -10)-1));
    var y = Math.floor(Math.random() * ((h * 10)-1));
    temparray[i] = [x,y];
  }
  for (i = (numStars/2 + 1); i <= 3*(numStars/4); i++) {
    // Get random positions for stars.
    var x = Math.floor(Math.random() * ((w * 10)-1));
    var y = Math.floor(Math.random() * ((h * -10)-1));
    temparray[i] = [x,y];
  }
  for (i = (3*(numStars/4) + 1); i <= numStars; i++) {
    // Get random positions for stars.
    var x = Math.floor(Math.random() * ((w * -10)-1));
    var y = Math.floor(Math.random() * ((h * -10)-1));
    temparray[i] = [x,y];
  }
  return temparray;
}
function stars(ctx, starlist, px, py, cw, ch) {
        for (var i in starlist) {
          var x = starlist[i][0];
          var y = starlist[i][1];
          // Make the stars white
          ctx.fillStyle = "white";
        //check if star would be within view field
        if (Math.abs(px - x) < cw/2 + 5 && Math.abs(py - y) < ch/2 + 5){
          //transform coords from world coordinate system to pixel coordinate system
          x = x + (cw/2);
          y = y + (ch/2);
          ctx.beginPath();
          ctx.arc(x - px, y - py, 3, 0, Math.PI * 2, true);
          ctx.closePath();
          ctx.fill();
        }
        }
      }

function drawPlayer(ctx, ship, x, y) {
  var context = ctx; 
  if (ship == 1) {
    ship1draw(ctx,x,y);
  }
  else if (ship == 2) {
    ship2draw(ctx,x,y);
  }
}

function framerateDraw(ctx) {
ctx.fillStyle = '#FFF';
ctx.font = 'bold 10px sans-serif';
ctx.fillText('FPS: ' + fps + '/' + maxfps, 5, 15);
}

window.addEventListener("load", game, true);
$(document.documentElement).keydown(function (event) {
  // handle cursor keys
  if (event.keyCode == 37) {
      leftp = true;
  } else if (event.keyCode == 39) {
      rightp = true;
  }
 if (event.keyCode == 38) {
      upp = true;
  } else if (event.keyCode == 40) {
      downp = true;
  }
  if (event.keyCode == 27) {
      xstop = true;
  }
});
//This handler detects when the keys are no longer being pressed
$(document.documentElement).keyup(function (event) {
  if (event.keyCode == 37) {
      leftp = false;
  } else if (event.keyCode == 39) {
      rightp = false;
  }
 if (event.keyCode == 38) {
      upp = false;
  } else if (event.keyCode == 40) {
      downp = false;
  }
  if (event.keyCode == 27) {
      xstop = false;
  }
});
</script>
</body>
</html>
