<!DOCTYPE html>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
</head>
<body>
<canvas id="game" style="border: 1px solid #000;" height="500" width="800">Your browser doesn't support canvas</canvas>
<script src="/socket.io/socket.io.js"></script>
<script>
  var socket = io.connect('http://localhost');
</script>
<script src="drawships.js"></script>
<script>
var x = 70;
var y = 70;
var myid = 0;
var ship;
var players = new Array();
var upp = false, downp = false, leftp = false, rightp = false;
socket.on('newstart', function (data) {
  x = data.x;
  y = data.y;
  myid = data.id;
  ship = data.ship;
  players = data.currentplayers;
  players[myid] = { id: myid, ship: ship, x: x, y: y };
});
socket.on('newguy', function (data) {
  players[data.id] = ({id: data.id, ship: data.ship, x: data.x, y: data.y });
  });
socket.on('update', function (data) {
   x = data.x;
   y = data.y;
  players[data.id] = { id: data.id, ship: data.ship, x: data.x, y: data.y };
  });
socket.on('removeplayer', function (data) {
  players.splice(data.id, 1, []);
});
function game() {
  // Get the canvas element and its drawing context
  var canvas = document.getElementById('game');
  var context = canvas.getContext('2d');
  var context_width = canvas.width;
  var context_height = canvas.height;
  var starlist = initiateStars();
  var gameloop = setInterval(function() {
  updateAll();
  context.fillStyle = 'black';
  context.fillRect(0, 0, 800, 500);
  drawAll(context, starlist);
  }, 1000 / 30);
}
function updateAll() {
  // send a single update packet with everything that's happened
  //here 'p' stands for pressed
  if (upp || downp || leftp || rightp) {
    socket.emit('movement', { id: myid, up: upp, down: downp, left: leftp, right: rightp });
  }
}
  
function drawAll(context, starlist) {
  stars(context, starlist);
  for (var playerid in players) {
    if (players[playerid].x != null) {
      drawPlayer(context, players[playerid].ship, players[playerid].x, players[playerid].y);
    }
  }
}
function initiateStars() {
  var array = new Array();
  // add 50 stars to the array 50 stars.
  for (i = 0; i <= 50; i++) {
    // Get random positions for stars.
    var x = Math.floor(Math.random() * 799);
    var y = Math.floor(Math.random() * 599);
    x[i] = [x,y];
  }
  return array;
}

function stars(ctx, starlist) {

        // Draw 50 stars.
        for (var i in starlist) {
          // Get random positions for stars.
          var x = starlist[i][0];
          var y = starlist[i][1];

          // Make the stars white
          ctx.fillStyle = "white";

          // Give the ship some room.
          //if (x < 30 || y < 30) ctx.fillStyle = "black";

          // Draw an individual star.
          ctx.beginPath();
          ctx.arc(x, y, 3, 0, Math.PI * 2, true);
          ctx.closePath();
          ctx.fill();
        }
      }

function drawPlayer(ctx, ship, x, y) {
  var context = ctx; 
  if (ship == 1) {
    ship1draw(ctx,x,y);
  }
  else if (ship == 2) {
    ship2draw(ctx,x,y);
  }
}

window.addEventListener("load", game, true);
$(document.documentElement).keydown(function (event) {
  // handle cursor keys
  if (event.keyCode == 37) {
      leftp = true;
  } else if (event.keyCode == 39) {
      rightp = true;
  }
 if (event.keyCode == 38) {
      upp = true;
  } else if (event.keyCode == 40) {
      downp = true;
  }
});
//This handler detects when the keys are no longer being pressed
$(document.documentElement).keyup(function (event) {
  if (event.keyCode == 37) {
      leftp = false;
  } else if (event.keyCode == 39) {
      rightp = false;
  }
 if (event.keyCode == 38) {
      upp = false;
  } else if (event.keyCode == 40) {
      downp = false;
  }
});
</script>
</body>
</html>
